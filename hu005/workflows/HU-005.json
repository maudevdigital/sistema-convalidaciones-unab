{
  "name": "HU-005: Notificación Corrección Documentos",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger-webhook-hu004",
      "name": "Webhook-HU004",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "hu005-notificacion-correccion"
    },
    {
      "parameters": {
        "functionCode": "// Validar estructura de datos recibidos\nconst input = $input.all()[0].json;\n// Los datos del webhook pueden estar en .body o directamente en el json\nconst data = input.body || input;\n\n// Validaciones\nconst validations = {\n  idSolicitud: !!data.idSolicitud,\n  estudianteNombre: !!data.estudiante?.nombre,\n  estudianteEmail: !!data.estudiante?.email && data.estudiante.email.includes('@'),\n  errorTipo: !!data.error?.tipo,\n  errorMensaje: !!data.error?.mensaje\n};\n\n// Verificar todas las validaciones\nconst allValid = Object.values(validations).every(v => v === true);\n\nif (!allValid) {\n  return {\n    json: {\n      error: true,\n      validations: validations,\n      message: \"Datos de entrada inválidos\",\n      received: data\n    }\n  };\n}\n\nreturn {\n  json: {\n    valid: true,\n    data: data\n  }\n};"
      },
      "id": "function-validar-entrada",
      "name": "Function-ValidarEntrada",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.valid}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-datos-validos",
      "name": "IF-DatosValidos",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "// Normaliza texto con mojibake típico (UTF-8 mal interpretado como Latin-1/Win-1252)\nfunction looksBroken(s) {\n  return /[Ã�]/.test(s) || /\\uFFFD/.test(s);\n}\nfunction tryLatin1ToUtf8(s) {\n  try { return Buffer.from(s, 'latin1').toString('utf8'); } catch (e) { return s; }\n}\nfunction tryBinaryToUtf8(s) {\n  try { return Buffer.from(s, 'binary').toString('utf8'); } catch (e) { return s; }\n}\nfunction scoreMojibake(s) {\n  const m = s.match(/[Ã�]/g);\n  return m ? m.length : 0;\n}\nfunction normalizeMojibake(s) {\n  if (typeof s !== 'string') return s;\n  const candidates = [s];\n  const a = tryLatin1ToUtf8(s); candidates.push(a);\n  const b = tryBinaryToUtf8(s); candidates.push(b);\n  const a2 = tryLatin1ToUtf8(a); candidates.push(a2);\n  const b2 = tryLatin1ToUtf8(b); candidates.push(b2);\n  let best = candidates[0];\n  let bestScore = scoreMojibake(best);\n  for (const c of candidates) {\n    const sc = scoreMojibake(c);\n    if (sc < bestScore) { best = c; bestScore = sc; }\n  }\n  return best;\n}\nfunction deepNormalize(obj) {\n  if (obj == null) return obj;\n  if (typeof obj === 'string') return normalizeMojibake(obj);\n  if (Array.isArray(obj)) return obj.map(deepNormalize);\n  if (typeof obj === 'object') {\n    const out = {};\n    for (const k of Object.keys(obj)) out[k] = deepNormalize(obj[k]);\n    return out;\n  }\n  return obj;\n}\n\nconst inputData = $input.all()[0].json;\nconst raw = inputData.data || inputData;\nconst data = deepNormalize(raw);\n\nreturn {\n  json: {\n    estudiante: {\n      nombre: data.estudiante?.nombre || '',\n      rut: data.estudiante?.rut || '',\n      email: data.estudiante?.email || ''\n    },\n    solicitud: {\n      id: data.idSolicitud,\n      timestamp: data.timestamp || new Date().toISOString()\n    },\n    error: {\n      tipo: data.error?.tipo,\n      mensaje: data.error?.mensaje,\n      detalles: data.error?.detalles || {}\n    },\n    metadata: {\n      workflow: \"HU-005\",\n      version: \"1.1\",\n      processed_at: new Date().toISOString()\n    }\n  }\n};"
      },
      "id": "function-preparar-datos",
      "name": "Function-PrepararDatos",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "functionCode": "const data = $input.all()[0].json;\n\n// Función para convertir MIME type a formato legible\nfunction formatoLegible(mimeType) {\n  const formatos = {\n    'application/pdf': 'PDF',\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Word (DOCX)',\n    'application/msword': 'Word (DOC)',\n    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excel (XLSX)',\n    'application/vnd.ms-excel': 'Excel (XLS)',\n    'image/jpeg': 'Imagen JPEG',\n    'image/jpg': 'Imagen JPG',\n    'image/png': 'Imagen PNG',\n    'application/zip': 'Archivo ZIP',\n    'text/plain': 'Texto plano'\n  };\n  return formatos[mimeType] || mimeType || 'Desconocido';\n}\n\nconst templates = {\n  formato_incorrecto: {\n    subject: \"Corrección Requerida - Formato de Documento Incorrecto\",\n    body: `<!doctype html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family: Arial, sans-serif; line-height:1.5;\">\n<p>Estimado/a [NOMBRE_ESTUDIANTE],</p>\n<p>Hemos recibido tu solicitud de convalidación (ID: <strong>[ID_SOLICITUD]</strong>), sin embargo, no podemos procesarla debido a que el documento adjunto no está en el formato correcto.</p>\n<h3>Problema detectado</h3>\n<ul>\n  <li><strong>Archivo recibido:</strong> [NOMBRE_ARCHIVO]</li>\n  <li><strong>Formato detectado:</strong> [TIPO_ARCHIVO]</li>\n  <li><strong>Motivo de rechazo:</strong> [MOTIVO_RECHAZO]</li>\n</ul>\n<h3>¿Cómo corregir?</h3>\n<ol>\n  <li>Convierte tu documento a formato <strong>PDF</strong>.</li>\n  <li>Verifica que el archivo no supere <strong>10 MB</strong>.</li>\n  <li>Reenvía tu solicitud haciendo clic aquí: <a href=\"[LINK_REENVIO]\">[LINK_REENVIO]</a></li>\n</ol>\n<h3>¿Necesitas ayuda?</h3>\n<p>Contacta a nuestro equipo: <a href=\"mailto:convalidaciones@unab.cl\">convalidaciones@unab.cl</a></p>\n<p>Saludos cordiales,<br>\nSistema de Convalidaciones Académicas<br>\nUniversidad Andrés Bello</p>\n</body></html>`\n  },\n  tamano_excedido: {\n    subject: \"Corrección Requerida - Archivo Demasiado Grande\",\n    body: `<!doctype html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family: Arial, sans-serif; line-height:1.5;\">\n<p>Estimado/a [NOMBRE_ESTUDIANTE],</p>\n<p>Hemos recibido tu solicitud de convalidación (ID: <strong>[ID_SOLICITUD]</strong>), sin embargo, no podemos procesarla debido a que el archivo adjunto supera el tamaño máximo permitido.</p>\n<h3>Problema detectado</h3>\n<ul>\n  <li><strong>Archivo recibido:</strong> [NOMBRE_ARCHIVO]</li>\n  <li><strong>Tamaño actual:</strong> [TAMANO_MB] MB</li>\n  <li><strong>Tamaño máximo:</strong> 10 MB</li>\n</ul>\n<h3>¿Cómo corregir?</h3>\n<ol>\n  <li>Comprime tu archivo <strong>PDF</strong>.</li>\n  <li>Verifica que el tamaño final sea menor a <strong>10 MB</strong>.</li>\n  <li>Reenvía tu solicitud: <a href=\"[LINK_REENVIO]\">[LINK_REENVIO]</a></li>\n</ol>\n<h3>¿Necesitas ayuda?</h3>\n<p>Contacta: <a href=\"mailto:convalidaciones@unab.cl\">convalidaciones@unab.cl</a></p>\n<p>Saludos cordiales,<br>\nSistema de Convalidaciones Académicas<br>\nUniversidad Andrés Bello</p>\n</body></html>`\n  },\n  archivo_corrupto: {\n    subject: \"Corrección Requerida - Archivo No Puede Ser Leído\",\n    body: `<!doctype html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family: Arial, sans-serif; line-height:1.5;\">\n<p>Estimado/a [NOMBRE_ESTUDIANTE],</p>\n<p>Hemos recibido tu solicitud de convalidación (ID: <strong>[ID_SOLICITUD]</strong>), sin embargo, no podemos procesarla debido a que el archivo adjunto no puede ser leído correctamente.</p>\n<h3>Problema detectado</h3>\n<ul>\n  <li><strong>Archivo recibido:</strong> [NOMBRE_ARCHIVO]</li>\n  <li><strong>Error:</strong> El archivo está corrupto o dañado</li>\n</ul>\n<h3>¿Cómo corregir?</h3>\n<ol>\n  <li>Verifica que el archivo <strong>PDF</strong> se abra correctamente.</li>\n  <li>Genera un nuevo PDF desde el documento original.</li>\n  <li>Reenvía tu solicitud: <a href=\"[LINK_REENVIO]\">[LINK_REENVIO]</a></li>\n</ol>\n<h3>¿Necesitas ayuda?</h3>\n<p>Contacta: <a href=\"mailto:convalidaciones@unab.cl\">convalidaciones@unab.cl</a></p>\n<p>Saludos cordiales,<br>\nSistema de Convalidaciones Académicas<br>\nUniversidad Andrés Bello</p>\n</body></html>`\n  },\n  campos_faltantes: {\n    subject: \"Corrección Requerida - Información Incompleta\",\n    body: `<!doctype html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family: Arial, sans-serif; line-height:1.5;\">\n<p>Estimado/a [NOMBRE_ESTUDIANTE],</p>\n<p>Hemos recibido tu solicitud de convalidación (ID: <strong>[ID_SOLICITUD]</strong>), sin embargo, no podemos procesarla porque falta información requerida.</p>\n<h3>Campos faltantes</h3>\n<pre style=\"background:#f6f8fa;padding:12px;border-radius:6px;\">[CAMPOS_FALTANTES]</pre>\n<h3>¿Cómo corregir?</h3>\n<ol>\n  <li>Completa todos los campos obligatorios.</li>\n  <li>Verifica la información adjunta.</li>\n  <li>Reenvía tu solicitud: <a href=\"[LINK_REENVIO]\">[LINK_REENVIO]</a></li>\n</ol>\n<h3>¿Necesitas ayuda?</h3>\n<p>Contacta: <a href=\"mailto:convalidaciones@unab.cl\">convalidaciones@unab.cl</a></p>\n<p>Saludos cordiales,<br>\nSistema de Convalidaciones Académicas<br>\nUniversidad Andrés Bello</p>\n</body></html>`\n  }\n};\n\nconst template = templates[data.error.tipo] || templates.formato_incorrecto;\n\n// Crear objeto con los valores de reemplazo\nconst replacements = {\n  'NOMBRE_ESTUDIANTE': data.estudiante.nombre,\n  'ID_SOLICITUD': data.solicitud.id,\n  'NOMBRE_ARCHIVO': data.error.detalles.archivoNombre || 'N/A',\n  'TIPO_ARCHIVO': formatoLegible(data.error.detalles.archivoTipo),\n  'TAMANO_MB': data.error.detalles.tamanoMB || 'N/A',\n  'MOTIVO_RECHAZO': data.error.detalles.motivoRechazo || data.error.mensaje,\n  'LINK_REENVIO': `https://formulario-convalidacion.unab.cl?retry=${data.solicitud.id}`,\n  'CAMPOS_FALTANTES': (data.error.detalles.camposFaltantes || []).map(c => `- ${c}`).join('\\n')\n};\n\n// Reemplazar placeholders en subject y body\nlet subject = template.subject;\nlet body = template.body;\nfor (const [key, value] of Object.entries(replacements)) {\n  const placeholder = `[${key}]`;\n  subject = subject.split(placeholder).join(String(value));\n  body = body.split(placeholder).join(String(value));\n}\n\nreturn {\n  json: {\n    to: data.estudiante.email,\n    from: 'maudevchile@gmail.com',\n    subject: subject,\n    body: body,\n    metadata: {\n      idSolicitud: data.solicitud.id,\n      tipoError: data.error.tipo,\n      templateUsado: data.error.tipo,\n      estudianteNombre: data.estudiante.nombre\n    }\n  }\n};"
      },
      "id": "function-redactar-email",
      "name": "Function-RedactarEmail",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "fromEmail": "={{$json.from}}",
        "toEmail": "={{$json.to}}",
        "subject": "={{$json.subject}}",
        "emailFormat": "html",
        "html": "={{$json.body}}",
        "options": {
          "allowUnauthorizedCerts": false
        }
      },
      "id": "email-correccion",
      "name": "Email-Correccion",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1250, 200],
      "credentials": {
        "smtp": "={{$credentials.smtp}}"
      },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 30000
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"success\": true, \"mensaje\": \"Email de corrección enviado exitosamente\", \"emailEnviado\": true}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "Respond-Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"success\": false, \"error\": \"Datos de entrada inválidos\", \"validations\": \"={{$json.validations}}\", \"mensaje\": \"Faltan campos requeridos o tienen formato incorrecto\"}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error-validacion",
      "name": "Respond-Error-Validacion",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "functionCode": "const error = $input.all()[0].json;\n\nreturn {\n  json: {\n    timestamp: new Date().toISOString(),\n    idSolicitud: \"UNKNOWN\",\n    tipo_notificacion: \"error_smtp\",\n    tipo_error: \"smtp_connection_failed\",\n    email_enviado: \"no\",\n    destinatario: \"UNKNOWN\",\n    estado_envio: \"fallido\",\n    intentos_envio: 3,\n    detalles_error: JSON.stringify(error)\n  }\n};"
      },
      "id": "function-log-error-smtp",
      "name": "Function-LogErrorSMTP",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1450, 400],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"success\": false, \"error\": \"Error al enviar email\", \"mensaje\": \"El sistema no pudo enviar el email de corrección. El caso ha sido marcado como pendiente de reenvío.\", \"intentos\": 3, \"estadoSolicitud\": \"pendiente_reenvio\"}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "respond-error-smtp",
      "name": "Respond-Error-SMTP",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 400]
    }
  ],
  "connections": {
    "Webhook-HU004": {
      "main": [
        [
          {
            "node": "Function-ValidarEntrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function-ValidarEntrada": {
      "main": [
        [
          {
            "node": "IF-DatosValidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF-DatosValidos": {
      "main": [
        [
          {
            "node": "Function-PrepararDatos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond-Error-Validacion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function-PrepararDatos": {
      "main": [
        [
          {
            "node": "Function-RedactarEmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function-RedactarEmail": {
      "main": [
        [
          {
            "node": "Email-Correccion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email-Correccion": {
      "main": [
        [
          {
            "node": "Respond-Success",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Function-LogErrorSMTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function-LogErrorSMTP": {
      "main": [
        [
          {
            "node": "Respond-Error-SMTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-11-09T14:30:00.000Z",
      "updatedAt": "2025-11-09T14:30:00.000Z",
      "id": "hu005",
      "name": "HU-005"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-09T14:30:00.000Z",
  "versionId": "1.1"
}
