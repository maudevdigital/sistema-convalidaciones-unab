# Helper para enviar JSON como UTF-8 bytes
function Send-JsonUtf8 {
  param(
    [Parameter(Mandatory=$true)][string]$Url,
    [Parameter(Mandatory=$true)][hashtable]$BodyObject
  )
  $json = $BodyObject | ConvertTo-Json -Depth 20
  $bytes = [System.Text.Encoding]::UTF8.GetBytes($json)
  Invoke-WebRequest -Uri $Url `
    -Method POST `
    -Body $bytes `
    -ContentType 'application/json; charset=utf-8'
}

$baseUrl = "http://localhost:5678/webhook/hu005-notificacion-correccion"

Write-Host ""
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "  EJECUTANDO PRUEBAS AUTOMÃTICAS HU-005 (UTF-8)" -ForegroundColor Yellow
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

# PRUEBA 1: formato_incorrecto
Write-Host "ğŸ§ª PRUEBA 1/4: formato_incorrecto (MarÃ­a JosÃ© PÃ©rez NÃºÃ±ez)" -ForegroundColor Green
$body1 = @{
  idSolicitud = "SOL-AUTO-001"
  timestamp   = (Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ")
  estudiante  = @{
    nombre = "MarÃ­a JosÃ© PÃ©rez NÃºÃ±ez"
    rut    = "12.345.678-9"
    email  = "lucasmaulenr@gmail.com"
  }
  error = @{
    tipo    = "formato_incorrecto"
    mensaje = "El archivo no estÃ¡ en formato PDF"
    detalles = @{
      archivoNombre = "certificado_notas.docx"
      archivoTipo   = "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
      motivoRechazo = "Solo se aceptan archivos en formato PDF"
    }
  }
}
$response1 = Send-JsonUtf8 -Url $baseUrl -BodyObject $body1
Write-Host "   âœ… Status: $($response1.StatusCode)" -ForegroundColor White
Start-Sleep -Seconds 1

# PRUEBA 2: tamano_excedido
Write-Host "ğŸ§ª PRUEBA 2/4: tamano_excedido (AndrÃ©s MuÃ±oz)" -ForegroundColor Green
$body2 = @{
  idSolicitud = "SOL-AUTO-002"
  timestamp   = (Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ")
  estudiante  = @{
    nombre = "AndrÃ©s MuÃ±oz"
    rut    = "23.456.789-0"
    email  = "lucasmaulenr@gmail.com"
  }
  error = @{
    tipo    = "tamano_excedido"
    mensaje = "El archivo supera el tamaÃ±o mÃ¡ximo permitido"
    detalles = @{
      archivoNombre = "certificado_notas.pdf"
      archivoTipo   = "application/pdf"
      tamanoMB      = "15.7"
    }
  }
}
$response2 = Send-JsonUtf8 -Url $baseUrl -BodyObject $body2
Write-Host "   âœ… Status: $($response2.StatusCode)" -ForegroundColor White
Start-Sleep -Seconds 1

# PRUEBA 3: archivo_corrupto
Write-Host "ğŸ§ª PRUEBA 3/4: archivo_corrupto (JosÃ© HernÃ¡ndez)" -ForegroundColor Green
$body3 = @{
  idSolicitud = "SOL-AUTO-003"
  timestamp   = (Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ")
  estudiante  = @{
    nombre = "JosÃ© HernÃ¡ndez"
    rut    = "34.567.890-1"
    email  = "lucasmaulenr@gmail.com"
  }
  error = @{
    tipo    = "archivo_corrupto"
    mensaje = "El archivo no puede ser leÃ­do"
    detalles = @{
      archivoNombre = "certificado_notas.pdf"
      archivoTipo   = "application/pdf"
    }
  }
}
$response3 = Send-JsonUtf8 -Url $baseUrl -BodyObject $body3
Write-Host "   âœ… Status: $($response3.StatusCode)" -ForegroundColor White
Start-Sleep -Seconds 1

# PRUEBA 4: campos_faltantes
Write-Host "ğŸ§ª PRUEBA 4/4: campos_faltantes (MarÃ­a FernÃ¡ndez)" -ForegroundColor Green
$body4 = @{
  idSolicitud = "SOL-AUTO-004"
  timestamp   = (Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ")
  estudiante  = @{
    nombre = "MarÃ­a FernÃ¡ndez"
    rut    = "45.678.901-2"
    email  = "lucasmaulenr@gmail.com"
  }
  error = @{
    tipo    = "campos_faltantes"
    mensaje = "Faltan campos obligatorios"
    detalles = @{
      camposFaltantes = @(
        "Nombre de la instituciÃ³n de origen",
        "AÃ±o de certificaciÃ³n",
        "Firma del estudiante"
      )
    }
  }
}
$response4 = Send-JsonUtf8 -Url $baseUrl -BodyObject $body4
Write-Host "   âœ… Status: $($response4.StatusCode)" -ForegroundColor White

Write-Host ""
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "  âœ… PRUEBAS COMPLETADAS (UTF-8)" -ForegroundColor Green
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""
Write-Host "ğŸ“§ Revisa tu email: lucasmaulenr@gmail.com" -ForegroundColor Yellow
