{
  "name": "Convalidaciones: HU-001 + HU-005",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "solicitud-convalidacion",
        "responseMode": "lastNode",
        "options": {
          "responseHeaders": {
            "entries": [
              { "name": "Content-Type", "value": "application/json" }
            ]
          }
        }
      },
      "name": "Webhook - Recepci√≥n",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300],
      "id": "webhook-recepcion",
      "webhookId": "0bb0b401-c93d-44db-b804-48ea7bd064f1"
    },
    {
      "parameters": {
        "functionCode": "// HU-01: Validaci√≥n de campos requeridos\nconst requiredFields = ['nombre', 'rut', 'carrera', 'asignatura', 'institucionOrigen'];\nconst errors = [];\nconst data = $input.item.json.body || $input.item.json;\n\n// Validar campos obligatorios\nfor (const field of requiredFields) {\n  if (!data[field] || data[field].toString().trim() === '') {\n    errors.push(`Campo requerido: ${field}`);\n  }\n}\n\n// Validar que haya archivo\nif (!data.file && !data.documentos) {\n  errors.push('Campo requerido: archivo PDF');\n}\n\n// Si hay errores, retornar respuesta de error\nif (errors.length > 0) {\n  return {\n    json: {\n      success: false,\n      errors: errors,\n      message: 'Faltan campos obligatorios',\n      code: 400\n    }\n  };\n}\n\n// Si todo est√° bien, procesar y agregar metadatos\nconst result = Object.assign({}, data, {\n  success: true,\n  documentosCompletos: true,\n  fechaSolicitud: new Date().toISOString(),\n  id: 'SOL-' + data.rut.replace(/[^0-9]/g, '') + '-' + Date.now(),\n  estado: 'Recibida',\n  // Preservar datos del archivo\n  fileName: data.file ? data.file.filename : data.documentos,\n  fileData: data.file ? data.file.data : null,\n  fileMimeType: data.file ? data.file.mimeType : 'application/pdf'\n});\n\nreturn { json: result };"
      },
      "name": "Function - Validar Campos",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300],
      "id": "validar-campos"
    },
    {
      "parameters": {
        "functionCode": "// Validar formato de RUT chileno\nconst data = $input.item.json;\n\nfunction validarRUT(rut) {\n  if (!rut) return false;\n  \n  // Eliminar puntos y gui√≥n\n  rut = rut.toString().replace(/\\./g, '').replace(/-/g, '').toUpperCase();\n  \n  // Verificar formato b√°sico (7-8 d√≠gitos + verificador)\n  if (!/^[0-9]{7,8}[0-9K]$/.test(rut)) {\n    return false;\n  }\n  \n  // Separar n√∫mero y d√≠gito verificador\n  const cuerpo = rut.slice(0, -1);\n  const dv = rut.slice(-1);\n  \n  // Calcular d√≠gito verificador\n  let suma = 0;\n  let multiplicador = 2;\n  \n  for (let i = cuerpo.length - 1; i >= 0; i--) {\n    suma += parseInt(cuerpo[i]) * multiplicador;\n    multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;\n  }\n  \n  const dvEsperado = 11 - (suma % 11);\n  const dvCalculado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();\n  \n  return dv === dvCalculado;\n}\n\n// Validar si existe el campo success\nif (!data.success) {\n  return { json: data };\n}\n\nconst rutValido = validarRUT(data.rut);\n\nif (!rutValido) {\n  return {\n    json: {\n      success: false,\n      errors: ['RUT inv√°lido: ' + data.rut],\n      message: 'El RUT proporcionado no es v√°lido',\n      code: 400,\n      detalles: 'Formato esperado: 12.345.678-9 o 12345678-9'\n    }\n  };\n}\n\n// RUT v√°lido, continuar\nreturn { json: data };"
      },
      "name": "Function - Validar RUT",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 300],
      "id": "validar-rut"
    },
    {
      "parameters": {
        "functionCode": "// Validar formato de email\nconst data = $input.item.json;\n\nfunction validarEmail(email) {\n  if (!email || email.trim() === '') {\n    return true; // Email es opcional\n  }\n  \n  // Regex para validar email\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  if (!emailRegex.test(email)) {\n    return false;\n  }\n  \n  // Validar longitud\n  if (email.length > 254) {\n    return false;\n  }\n  \n  return true;\n}\n\n// Validar si existe el campo success\nif (!data.success) {\n  return { json: data };\n}\n\nconst emailValido = validarEmail(data.email);\n\nif (!emailValido) {\n  return {\n    json: {\n      success: false,\n      errors: ['Email inv√°lido: ' + data.email],\n      message: 'El email proporcionado no es v√°lido',\n      code: 400\n    }\n  };\n}\n\n// Email v√°lido, continuar\nreturn { json: data };"
      },
      "name": "Function - Validar Email",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 300],
      "id": "validar-email"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            { "value1": "={{$json.success}}", "value2": true }
          ]
        }
      },
      "name": "IF - Validaci√≥n OK",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1120, 300],
      "id": "if-validacion-ok"
    },
    {
      "parameters": {
        "functionCode": "// HU-01: Validar formato de documentos PDF\nconst data = $input.item.json;\nconst fileName = data.fileName || data.documentos || '';\nlet pdfsOk = true;\nlet badFiles = [];\n\n// Validar extensi√≥n\nif (typeof fileName === 'string') {\n  if (!fileName.toLowerCase().endsWith('.pdf')) {\n    pdfsOk = false;\n    badFiles.push(fileName);\n  }\n} else if (Array.isArray(fileName)) {\n  for (const doc of fileName) {\n    const name = doc.fileName || doc.name || doc;\n    if (typeof name === 'string' && !name.toLowerCase().endsWith('.pdf')) {\n      pdfsOk = false;\n      badFiles.push(name);\n    }\n  }\n}\n\n// Validar tipo MIME si existe\nif (data.fileMimeType && data.fileMimeType !== 'application/pdf') {\n  pdfsOk = false;\n  badFiles.push(`Tipo MIME incorrecto: ${data.fileMimeType}`);\n}\n\nconst result = Object.assign({}, data, {\n  pdfsOk: pdfsOk,\n  badFiles: badFiles,\n  validacionPDF: pdfsOk ? 'Documentos v√°lidos' : 'Documentos inv√°lidos'\n});\n\nreturn { json: result };"
      },
      "name": "Function - Validar PDF",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 200],
      "id": "validar-pdf"
    },
    {
      "parameters": {
        "functionCode": "// Validar tama√±o del archivo PDF (max 10MB)\nconst data = $input.item.json;\nconst MAX_SIZE_MB = 10;\nconst MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;\n\nlet sizeOk = true;\nlet sizeError = '';\n\n// Si tenemos datos del archivo\nif (data.fileData) {\n  // Calcular tama√±o del base64\n  const base64Length = data.fileData.length;\n  const fileSizeBytes = (base64Length * 3) / 4;\n  \n  if (fileSizeBytes > MAX_SIZE_BYTES) {\n    sizeOk = false;\n    sizeError = `Archivo muy grande: ${(fileSizeBytes / 1024 / 1024).toFixed(2)}MB. M√°ximo: ${MAX_SIZE_MB}MB`;\n  }\n  \n  // Agregar tama√±o al objeto\n  data.fileSize = fileSizeBytes;\n  data.fileSizeMB = (fileSizeBytes / 1024 / 1024).toFixed(2);\n}\n\nconst result = Object.assign({}, data, {\n  sizeOk: sizeOk,\n  sizeError: sizeError,\n  validacionTama√±o: sizeOk ? 'Tama√±o v√°lido' : 'Archivo muy grande'\n});\n\nreturn { json: result };"
      },
      "name": "Function - Validar Tama√±o",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1560, 200],
      "id": "validar-tamano"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            { "value1": "={{$json.pdfsOk && $json.sizeOk}}", "value2": true }
          ]
        }
      },
      "name": "IF - PDF V√°lido",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1780, 200],
      "id": "if-pdf-valido"
    },
    {
      "parameters": {
        "jsCode": "// Convertir base64 a binario para Google Drive\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const data = item.json;\n  \n  // Obtener datos del archivo\n  const base64Data = data.fileData || (data.file ? data.file.data : null);\n  const fileName = data.fileName || (data.file ? data.file.filename : 'documento.pdf');\n  const mimeType = data.fileMimeType || (data.file ? data.file.mimeType : 'application/pdf');\n  \n  if (!base64Data) {\n    throw new Error('No se encontraron datos del archivo para subir a Drive');\n  }\n  \n  // Convertir base64 a buffer binario\n  const binaryBuffer = Buffer.from(base64Data, 'base64');\n  \n  // Crear objeto con datos binarios para Google Drive\n  results.push({\n    json: data,\n    binary: {\n      data: {\n        data: binaryBuffer.toString('base64'),\n        mimeType: mimeType,\n        fileName: fileName,\n        fileExtension: 'pdf'\n      }\n    }\n  });\n}\n\nreturn results;"
      },
      "name": "Code - Convertir a Binario",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 100],
      "id": "convertir-binario",
      "notes": "Convierte el archivo base64 del JSON a formato binario para Google Drive"
    },
    {
      "parameters": {
        "operation": "upload",
        "folderId": { "__rl": true, "value": "", "mode": "list" },
        "name": "={{$json.id}}_{{$json.fileName}}",
        "binaryData": true,
        "binaryPropertyName": "data",
        "options": {}
      },
      "name": "Drive - Subir PDF",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [2000, 100],
      "id": "drive-subir-pdf",
      "credentials": {
        "googleDriveOAuth2Api": { "id": "PENDIENTE", "name": "Google Drive account" }
      },
      "notes": "CONFIGURAR: Seleccionar carpeta de Drive y credenciales"
    },
    {
      "parameters": {
        "functionCode": "// Obtener link del archivo subido a Drive y preservar todos los datos\nconst driveData = $input.item.json;\nconst originalData = $('IF - PDF V√°lido').item.json;\n\n// El nodo de Google Drive retorna informaci√≥n del archivo\nconst fileId = driveData.id;\nconst fileName = driveData.name;\nconst webViewLink = `https://drive.google.com/file/d/${fileId}/view`;\nconst webContentLink = `https://drive.google.com/uc?id=${fileId}&export=download`;\n\n// Combinar con datos originales, PRESERVANDO el ID de solicitud\nconst result = Object.assign({}, originalData, {\n  driveFileId: fileId,\n  driveFileName: fileName,\n  linkDrive: webViewLink,\n  linkDirecto: webContentLink\n});\n\nreturn { json: result };"
      },
      "name": "Function - Preparar Link Drive",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2220, 100],
      "id": "preparar-link-drive"
    },
    {
      "parameters": {
        "functionCode": "// HU-01: Preparar datos LIMPIOS para Solicitudes\nconst data = $input.item.json;\n\nreturn {\n  json: {\n    id: data.id || 'ERROR-SIN-ID',\n    fecha: data.fechaSolicitud,\n    estudiante: data.nombre,\n    rut: data.rut,\n    carrera: data.carrera,\n    asignatura: data.asignatura,\n    institucionOrigen: data.institucionOrigen,\n    documentos: data.fileName || data.documentos,\n    linkDrive: data.linkDrive || 'Pendiente',\n    driveFileId: data.driveFileId || '',\n    tamanoMB: data.fileSizeMB || '',\n    email: data.email || '',\n    estado: data.estado\n  }\n};"
      },
      "name": "Preparar Datos Solicitudes",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2440, 100],
      "id": "preparar-solicitudes"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1FWnWVXKy8mKIbO2JloHav9y7rYJYpVIqM1qcVhtg0yY",
          "mode": "list",
          "cachedResultName": "Sistema Convalidaciones Acad√©micas"
        },
        "sheetName": {
          "__rl": true,
          "value": 392534325,
          "mode": "list",
          "cachedResultName": "Solicitudes"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{$json.id}}",
            "fecha": "={{$json.fecha}}",
            "estudiante": "={{$json.estudiante}}",
            "rut": "={{$json.rut}}",
            "carrera": "={{$json.carrera}}",
            "asignatura": "={{$json.asignatura}}",
            "institucionOrigen": "={{$json.institucionOrigen}}",
            "documentos": "={{$json.documentos}}",
            "linkDrive": "={{$json.linkDrive}}",
            "driveFileId": "={{$json.driveFileId}}",
            "tamanoMB": "={{$json.tamanoMB}}",
            "email": "={{$json.email}}",
            "estado": "={{$json.estado}}"
          },
          "matchingColumns": ["id"],
          "schema": []
        },
        "options": {}
      },
      "name": "DB-Registro",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [2660, 100],
      "id": "db-registro",
      "credentials": {
        "googleSheetsOAuth2Api": { "id": "ZM6AB0udQM5h68On", "name": "Google Sheets account" }
      }
    },
    {
      "parameters": {
        "functionCode": "// HU-01: Preparar datos LIMPIOS para Log\nconst data = $input.item.json;\n\nreturn {\n  json: {\n    timestamp: data.fechaSolicitud,\n    id: data.id,\n    evento: 'Solicitud Recibida',\n    estudiante: data.nombre,\n    estado: data.estado,\n    detalles: `HU-01: Recepci√≥n exitosa - Asignatura: ${data.asignatura} - Instituci√≥n: ${data.institucionOrigen} - Archivo: ${data.fileName || data.documentos}`\n  }\n};"
      },
      "name": "Preparar Datos Log",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2000, 200],
      "id": "preparar-log"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1FWnWVXKy8mKIbO2JloHav9y7rYJYpVIqM1qcVhtg0yY",
          "mode": "list",
          "cachedResultName": "Sistema Convalidaciones Acad√©micas"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Logs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{$json.timestamp}}",
            "id": "={{$json.id}}",
            "evento": "={{$json.evento}}",
            "estudiante": "={{$json.estudiante}}",
            "estado": "={{$json.estado}}",
            "detalles": "={{$json.detalles}}"
          },
          "matchingColumns": ["id"],
          "schema": []
        },
        "options": {}
      },
      "name": "DB-Log",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [2220, 200],
      "id": "db-log",
      "credentials": {
        "googleSheetsOAuth2Api": { "id": "ZM6AB0udQM5h68On", "name": "Google Sheets account" }
      }
    },
    {
      "parameters": {
        "fromEmail": "maudevchile@gmail.com",
        "toEmail": "={{$json.email || 'estudiante@ejemplo.com'}}",
        "subject": "=Confirmaci√≥n de Recepci√≥n - Solicitud {{$json.id}}",
        "text": "=Estimado/a {{$json.nombre}},\n\nHemos recibido correctamente su solicitud de convalidaci√≥n con los siguientes datos:\n\nüìã DATOS DE LA SOLICITUD:\n‚Ä¢ ID de Solicitud: {{$json.id}}\n‚Ä¢ Fecha de Recepci√≥n: {{$json.fechaSolicitud}}\n‚Ä¢ Asignatura: {{$json.asignatura}}\n‚Ä¢ Instituci√≥n de Origen: {{$json.institucionOrigen}}\n‚Ä¢ Estado: {{$json.estado}}\n\nüìÑ DOCUMENTO ADJUNTO:\n‚Ä¢ Nombre: {{$json.fileName}}\n\nüìÖ PR√ìXIMOS PASOS:\n1. Su solicitud ser√° revisada por la Direcci√≥n Acad√©mica\n2. Recibir√° una notificaci√≥n cuando haya una decisi√≥n\n3. El proceso puede tomar entre 5-10 d√≠as h√°biles\n\nüí° Para consultas, puede contactarnos indicando su ID de solicitud: {{$json.id}}\n\nSaludos cordiales,\nSistema Automatizado de Convalidaciones\nUniversidad Andr√©s Bello",
        "options": {}
      },
      "name": "Email-Confirmaci√≥n",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [2000, 300],
      "id": "email-confirmacion",
      "credentials": {
        "smtp": { "id": "5PwfuVROJgdj9gpi", "name": "SMTP account" }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/hu005-notificacion-correccion",
        "authentication": "none",
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={{ {\n  \"idSolicitud\": $json.id,\n  \"estudiante\": {\n    \"nombre\": $json.nombre,\n    \"rut\": $json.rut,\n    \"email\": $json.email || \"sin-email@unab.cl\"\n  },\n  \"error\": {\n    \"tipo\": $json.pdfsOk ? \"tamano_excedido\" : \"formato_incorrecto\",\n    \"mensaje\": $json.sizeError || $json.badFiles.join(\", \"),\n    \"detalles\": {\n      \"archivoNombre\": $json.fileName,\n      \"archivoTipo\": $json.fileMimeType,\n      \"tamanoMB\": $json.fileSizeMB,\n      \"motivoRechazo\": $json.pdfsOk ? \"Archivo supera los 10 MB permitidos\" : \"Formato de archivo no v√°lido - Solo se aceptan PDF\"\n    }\n  }\n} }}",
        "options": {}
      },
      "name": "HTTP-Notificar HU-005",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 400],
      "id": "http-notificar-hu005",
      "notes": "Llama al webhook HU-005 para enviar email de correcci√≥n personalizado"
    },
    {
      "parameters": {
        "functionCode": "// Preparar log de error de PDF\nconst data = $input.item.json;\n\nreturn {\n  json: {\n    timestamp: new Date().toISOString(),\n    id: data.id || 'ERROR-' + Date.now(),\n    evento: 'Error en Documento PDF',\n    estudiante: data.nombre,\n    estado: 'Rechazada - PDF Inv√°lido',\n    detalles: `Problemas: ${data.badFiles ? data.badFiles.join(', ') : 'Formato no PDF'}. ${data.sizeError || ''}`\n  }\n};"
      },
      "name": "Function - Log Error PDF",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2220, 400],
      "id": "log-error-pdf"
    },
    {
      "parameters": {
        "functionCode": "// Respuesta de error cuando el PDF es inv√°lido\nconst data = $input.item.json;\n\nreturn {\n  json: {\n    success: false,\n    message: 'Documento PDF no v√°lido',\n    errors: data.badFiles || ['Archivo no es PDF'],\n    detalles: data.sizeError || 'Solo se aceptan archivos PDF de m√°ximo 10MB',\n    id: data.id,\n    code: 400\n  }\n};"
      },
      "name": "Function - Error PDF Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2440, 400],
      "id": "error-pdf-response"
    },
    {
      "parameters": {
        "functionCode": "// Preparar log de error de validaci√≥n\nconst data = $input.item.json;\n\nreturn {\n  json: {\n    timestamp: new Date().toISOString(),\n    id: 'ERROR-' + Date.now(),\n    evento: 'Error de Validaci√≥n',\n    estudiante: data.nombre || 'Desconocido',\n    estado: 'Rechazada',\n    detalles: `Errores: ${data.errors ? data.errors.join(', ') : 'Error desconocido'}. ${data.detalles || ''}`\n  }\n};"
      },
      "name": "Function - Log Error Validaci√≥n",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 400],
      "id": "log-error-validacion"
    },
    {
      "parameters": {
        "functionCode": "// Respuesta de error para solicitudes inv√°lidas\nconst data = $input.item.json;\n\nreturn {\n  json: {\n    success: false,\n    message: data.message || 'Error en la validaci√≥n',\n    errors: data.errors || ['Error desconocido'],\n    detalles: data.detalles || 'Verifique los campos requeridos',\n    code: data.code || 400\n  }\n};"
      },
      "name": "Function-Error Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1560, 400],
      "id": "error-validacion-response"
    },
    {
      "parameters": {
        "jsCode": "// Sincronizar y preservar el ID original generado al inicio\nconst allItems = $input.all();\n\n// PASO 1: Buscar el item que tiene el ID original (formato SOL-XXXXX-timestamp)\nlet itemConIdOriginal = null;\nlet itemConDatosCompletos = null;\n\nfor (const item of allItems) {\n  const id = item.json.id;\n  \n  if (id && id.startsWith('SOL-') && id.split('-').length === 3) {\n    itemConIdOriginal = item;\n  }\n  \n  if (!itemConDatosCompletos || Object.keys(item.json).length > Object.keys(itemConDatosCompletos.json).length) {\n    itemConDatosCompletos = item;\n  }\n}\n\n// PASO 2: Fusionar datos\nif (itemConIdOriginal && itemConDatosCompletos && itemConIdOriginal !== itemConDatosCompletos) {\n  const merged = {\n    json: {\n      ...itemConDatosCompletos.json,\n      id: itemConIdOriginal.json.id,\n      fechaSolicitud: itemConIdOriginal.json.fechaSolicitud || itemConDatosCompletos.json.fechaSolicitud\n    }\n  };\n  return merged;\n}\n\n// PASO 3: Si encontramos el ID original, usarlo\nif (itemConIdOriginal) {\n  return itemConIdOriginal;\n}\n\n// PASO 4: Si no, usar el m√°s completo\nreturn itemConDatosCompletos || $input.last();"
      },
      "name": "Sincronizar - Preservar Datos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2880, 200],
      "id": "sincronizar-datos"
    },
    {
      "parameters": {
        "functionCode": "// Respuesta exitosa tras procesar la solicitud\nconst data = $input.item.json;\n\n// Buscar el ID en posibles ubicaciones\nlet solicitudId = data.id || data.solicitudId || data.ID || data.idSolicitud || data.solicitud_id;\n\nif (!solicitudId && data.sheets) solicitudId = data.sheets.id || data.sheets.solicitudId;\n\nif (!solicitudId && data.range) {\n  const match = data.range.match(/\\d+/);\n  if (match) solicitudId = `SOL-${match[0]}`;\n}\n\nif (!solicitudId) {\n  solicitudId = `SOL-TEMP-${Date.now()}`;\n}\n\nreturn {\n  json: {\n    success: true,\n    message: 'Solicitud recibida y procesada correctamente',\n    id: solicitudId,\n    fechaSolicitud: data.fechaSolicitud || data.fecha || new Date().toISOString(),\n    estado: data.estado || 'Recibida',\n    linkDrive: data.linkDrive || '',\n    driveFileId: data.driveFileId || '',\n    proximosPasos: 'Recibir√° notificaci√≥n por email con el estado de su solicitud',\n    tiempoEstimado: '5-10 d√≠as h√°biles',\n    code: 200\n  }\n};"
      },
      "name": "Function-Success Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [3100, 200],
      "id": "success-response"
    },

    {
      "parameters": {
        "httpMethod": "POST",
        "path": "hu005-notificacion-correccion",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "trigger-webhook-hu004",
      "name": "Webhook-HU004",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [250, 700],
      "webhookId": "hu005-notificacion-correccion"
    },
    {
      "parameters": {
        "functionCode": "// Validar estructura de datos recibidos\nconst input = $input.all()[0].json;\nconst data = input.body || input;\n\nconst validations = {\n  idSolicitud: !!data.idSolicitud,\n  estudianteNombre: !!data.estudiante?.nombre,\n  estudianteEmail: !!data.estudiante?.email && data.estudiante.email.includes('@'),\n  errorTipo: !!data.error?.tipo,\n  errorMensaje: !!data.error?.mensaje\n};\n\nconst allValid = Object.values(validations).every(v => v === true);\n\nif (!allValid) {\n  return { json: { error: true, validations, message: 'Datos de entrada inv√°lidos', received: data } };\n}\n\nreturn { json: { valid: true, data } };"
      },
      "id": "function-validar-entrada",
      "name": "Function-ValidarEntrada",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 700]
    },
    {
      "parameters": {
        "conditions": { "boolean": [ { "value1": "={{$json.valid}}", "value2": true } ] }
      },
      "id": "if-datos-validos",
      "name": "IF-DatosValidos",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 700]
    },
    {
      "parameters": {
        "functionCode": "// Normaliza texto con mojibake t√≠pico\nfunction tryLatin1ToUtf8(s){try{return Buffer.from(s,'latin1').toString('utf8');}catch(e){return s;}}\nfunction tryBinaryToUtf8(s){try{return Buffer.from(s,'binary').toString('utf8');}catch(e){return s;}}\nfunction score(s){const m=s.match(/[√ÉÔøΩ]/g);return m?m.length:0;}\nfunction norm(s){if(typeof s!=='string')return s;const c=[s,tryLatin1ToUtf8(s),tryBinaryToUtf8(s)];const a=tryLatin1ToUtf8(c[1]);const b=tryLatin1ToUtf8(c[2]);c.push(a,b);let best=c[0],bs=score(best);for(const x of c){const sc=score(x);if(sc<bs){best=x;bs=sc;}}return best;}\nfunction deep(o){if(o==null)return o;if(typeof o==='string')return norm(o);if(Array.isArray(o))return o.map(deep);if(typeof o==='object'){const out={};for(const k of Object.keys(o))out[k]=deep(o[k]);return out;}return o;}\n\nconst inputData = $input.all()[0].json; const raw = inputData.data || inputData; const data = deep(raw);\n\nreturn {\n  json: {\n    estudiante: { nombre: data.estudiante?.nombre || '', rut: data.estudiante?.rut || '', email: data.estudiante?.email || '' },\n    solicitud: { id: data.idSolicitud, timestamp: data.timestamp || new Date().toISOString() },\n    error: { tipo: data.error?.tipo, mensaje: data.error?.mensaje, detalles: data.error?.detalles || {} },\n    metadata: { workflow: 'HU-005', version: '1.1', processed_at: new Date().toISOString() }\n  }\n};"
      },
      "id": "function-preparar-datos",
      "name": "Function-PrepararDatos",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 600]
    },
    {
      "parameters": {
        "functionCode": "const data = $input.all()[0].json;\nfunction formatoLegible(m){const f={'application/pdf':'PDF','application/vnd.openxmlformats-officedocument.wordprocessingml.document':'Word (DOCX)','application/msword':'Word (DOC)','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':'Excel (XLSX)','application/vnd.ms-excel':'Excel (XLS)','image/jpeg':'Imagen JPEG','image/jpg':'Imagen JPG','image/png':'Imagen PNG','application/zip':'Archivo ZIP','text/plain':'Texto plano'};return f[m]||m||'Desconocido';}\n\nconst templates={\n  formato_incorrecto:{subject:'Correcci√≥n Requerida - Formato de Documento Incorrecto',body:`<!doctype html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family: Arial, sans-serif; line-height:1.5;\"><p>Estimado/a [NOMBRE_ESTUDIANTE],</p><p>Hemos recibido tu solicitud de convalidaci√≥n (ID: <strong>[ID_SOLICITUD]</strong>), sin embargo, no podemos procesarla debido a que el documento adjunto no est√° en el formato correcto.</p><h3>Problema detectado</h3><ul><li><strong>Archivo recibido:</strong> [NOMBRE_ARCHIVO]</li><li><strong>Formato detectado:</strong> [TIPO_ARCHIVO]</li><li><strong>Motivo de rechazo:</strong> [MOTIVO_RECHAZO]</li></ul><h3>¬øC√≥mo corregir?</h3><ol><li>Convierte tu documento a formato <strong>PDF</strong>.</li><li>Verifica que el archivo no supere <strong>10 MB</strong>.</li><li>Reenv√≠a tu solicitud haciendo clic aqu√≠: <a href=\"[LINK_REENVIO]\">[LINK_REENVIO]</a></li></ol><h3>¬øNecesitas ayuda?</h3><p>Contacta a nuestro equipo: <a href=\"mailto:convalidaciones@unab.cl\">convalidaciones@unab.cl</a></p><p>Saludos cordiales,<br>Sistema de Convalidaciones Acad√©micas<br>Universidad Andr√©s Bello</p></body></html>`},\n  tamano_excedido:{subject:'Correcci√≥n Requerida - Archivo Demasiado Grande',body:`<!doctype html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family: Arial, sans-serif; line-height:1.5;\"><p>Estimado/a [NOMBRE_ESTUDIANTE],</p><p>Hemos recibido tu solicitud de convalidaci√≥n (ID: <strong>[ID_SOLICITUD]</strong>), sin embargo, no podemos procesarla debido a que el archivo adjunto supera el tama√±o m√°ximo permitido.</p><h3>Problema detectado</h3><ul><li><strong>Archivo recibido:</strong> [NOMBRE_ARCHIVO]</li><li><strong>Tama√±o actual:</strong> [TAMANO_MB] MB</li><li><strong>Tama√±o m√°ximo:</strong> 10 MB</li></ul><h3>¬øC√≥mo corregir?</h3><ol><li>Comprime tu archivo <strong>PDF</strong>.</li><li>Verifica que el tama√±o final sea menor a <strong>10 MB</strong>.</li><li>Reenv√≠a tu solicitud: <a href=\"[LINK_REENVIO]\">[LINK_REENVIO]</a></li></ol><h3>¬øNecesitas ayuda?</h3><p>Contacta: <a href=\"mailto:convalidaciones@unab.cl\">convalidaciones@unab.cl</a></p><p>Saludos cordiales,<br>Sistema de Convalidaciones Acad√©micas<br>Universidad Andr√©s Bello</p></body></html>`},\n  archivo_corrupto:{subject:'Correcci√≥n Requerida - Archivo No Puede Ser Le√≠do',body:`<!doctype html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family: Arial, sans-serif; line-height:1.5;\"><p>Estimado/a [NOMBRE_ESTUDIANTE],</p><p>Hemos recibido tu solicitud de convalidaci√≥n (ID: <strong>[ID_SOLICITUD]</strong>), sin embargo, no podemos procesarla debido a que el archivo adjunto no puede ser le√≠do correctamente.</p><h3>Problema detectado</h3><ul><li><strong>Archivo recibido:</strong> [NOMBRE_ARCHIVO]</li><li><strong>Error:</strong> El archivo est√° corrupto o da√±ado</li></ul><h3>¬øC√≥mo corregir?</h3><ol><li>Verifica que el archivo <strong>PDF</strong> se abra correctamente.</li><li>Genera un nuevo PDF desde el documento original.</li><li>Reenv√≠a tu solicitud: <a href=\"[LINK_REENVIO]\">[LINK_REENVIO]</a></li></ol><h3>¬øNecesitas ayuda?</h3><p>Contacta: <a href=\"mailto:convalidaciones@unab.cl\">convalidaciones@unab.cl</a></p><p>Saludos cordiales,<br>Sistema de Convalidaciones Acad√©micas<br>Universidad Andr√©s Bello</p></body></html>`},\n  campos_faltantes:{subject:'Correcci√≥n Requerida - Informaci√≥n Incompleta',body:`<!doctype html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family: Arial, sans-serif; line-height:1.5;\"><p>Estimado/a [NOMBRE_ESTUDIANTE],</p><p>Hemos recibido tu solicitud de convalidaci√≥n (ID: <strong>[ID_SOLICITUD]</strong>), sin embargo, no podemos procesarla porque falta informaci√≥n requerida.</p><h3>Campos faltantes</h3><pre style=\"background:#f6f8fa;padding:12px;border-radius:6px;\">[CAMPOS_FALTANTES]</pre><h3>¬øC√≥mo corregir?</h3><ol><li>Completa todos los campos obligatorios.</li><li>Verifica la informaci√≥n adjunta.</li><li>Reenv√≠a tu solicitud: <a href=\"[LINK_REENVIO]\">[LINK_REENVIO]</a></li></ol><h3>¬øNecesitas ayuda?</h3><p>Contacta: <a href=\"mailto:convalidaciones@unab.cl\">convalidaciones@unab.cl</a></p><p>Saludos cordiales,<br>Sistema de Convalidaciones Acad√©micas<br>Universidad Andr√©s Bello</p></body></html>`}\n};\n\nconst template = templates[data.error.tipo] || templates.formato_incorrecto;\nconst replacements={\n  'NOMBRE_ESTUDIANTE': data.estudiante.nombre,\n  'ID_SOLICITUD': data.solicitud.id,\n  'NOMBRE_ARCHIVO': data.error.detalles.archivoNombre || 'N/A',\n  'TIPO_ARCHIVO': formatoLegible(data.error.detalles.archivoTipo),\n  'TAMANO_MB': data.error.detalles.tamanoMB || 'N/A',\n  'MOTIVO_RECHAZO': data.error.detalles.motivoRechazo || data.error.mensaje,\n  'LINK_REENVIO': `https://formulario-convalidacion.unab.cl?retry=${data.solicitud.id}`,\n  'CAMPOS_FALTANTES': (data.error.detalles.camposFaltantes || []).map(c=>`- ${c}`).join('\\n')\n};\nlet subject=template.subject; let body=template.body; for(const [k,v] of Object.entries(replacements)){const p=`[${k}]`; subject=subject.split(p).join(String(v)); body=body.split(p).join(String(v));}\n\nreturn { json: { to: data.estudiante.email, from:'maudevchile@gmail.com', subject, body, metadata:{ idSolicitud:data.solicitud.id, tipoError:data.error.tipo, templateUsado:data.error.tipo, estudianteNombre:data.estudiante.nombre } } };"
      },
      "id": "function-redactar-email",
      "name": "Function-RedactarEmail",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 600]
    },
    {
      "parameters": {
        "fromEmail": "={{$json.from}}",
        "toEmail": "={{$json.to}}",
        "subject": "={{$json.subject}}",
        "emailFormat": "html",
        "html": "={{$json.body}}",
        "options": { "allowUnauthorizedCerts": false }
      },
      "id": "email-correccion",
      "name": "Email-Correccion",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1250, 600],
      "credentials": { "smtp": "={{$credentials.smtp}}" },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 30000
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"success\": true, \"mensaje\": \"Email de correcci√≥n enviado exitosamente\", \"emailEnviado\": true}",
        "options": { "responseCode": 200 }
      },
      "id": "respond-success",
      "name": "Respond-Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1450, 600]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"success\": false, \"error\": \"Datos de entrada inv√°lidos\", \"validations\": \"={{$json.validations}}\", \"mensaje\": \"Faltan campos requeridos o tienen formato incorrecto\"}",
        "options": { "responseCode": 400 }
      },
      "id": "respond-error-validacion",
      "name": "Respond-Error-Validacion",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [850, 800]
    },
    {
      "parameters": {
        "functionCode": "const error = $input.all()[0].json;\nreturn { json: { timestamp: new Date().toISOString(), idSolicitud:'UNKNOWN', tipo_notificacion:'error_smtp', tipo_error:'smtp_connection_failed', email_enviado:'no', destinatario:'UNKNOWN', estado_envio:'fallido', intentos_envio:3, detalles_error: JSON.stringify(error) } };"
      },
      "id": "function-log-error-smtp",
      "name": "Function-LogErrorSMTP",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1450, 800],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"success\": false, \"error\": \"Error al enviar email\", \"mensaje\": \"El sistema no pudo enviar el email de correcci√≥n. El caso ha sido marcado como pendiente de reenv√≠o.\", \"intentos\": 3, \"estadoSolicitud\": \"pendiente_reenvio\"}",
        "options": { "responseCode": 500 }
      },
      "id": "respond-error-smtp",
      "name": "Respond-Error-SMTP",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 800]
    }
  ],
  "connections": {
    "Webhook - Recepci√≥n": { "main": [[{ "node": "Function - Validar Campos", "type": "main", "index": 0 }]] },
    "Function - Validar Campos": { "main": [[{ "node": "Function - Validar RUT", "type": "main", "index": 0 }]] },
    "Function - Validar RUT": { "main": [[{ "node": "Function - Validar Email", "type": "main", "index": 0 }]] },
    "Function - Validar Email": { "main": [[{ "node": "IF - Validaci√≥n OK", "type": "main", "index": 0 }]] },
    "IF - Validaci√≥n OK": {
      "main": [
        [{ "node": "Function - Validar PDF", "type": "main", "index": 0 }],
        [{ "node": "Function - Log Error Validaci√≥n", "type": "main", "index": 0 }]
      ]
    },
    "Function - Validar PDF": { "main": [[{ "node": "Function - Validar Tama√±o", "type": "main", "index": 0 }]] },
    "Function - Validar Tama√±o": { "main": [[{ "node": "IF - PDF V√°lido", "type": "main", "index": 0 }]] },
    "IF - PDF V√°lido": {
      "main": [
        [
          { "node": "Code - Convertir a Binario", "type": "main", "index": 0 },
          { "node": "Preparar Datos Log", "type": "main", "index": 0 },
          { "node": "Email-Confirmaci√≥n", "type": "main", "index": 0 }
        ],
        [{ "node": "HTTP-Notificar HU-005", "type": "main", "index": 0 }]
      ]
    },
    "Code - Convertir a Binario": { "main": [[{ "node": "Drive - Subir PDF", "type": "main", "index": 0 }]] },
    "Drive - Subir PDF": { "main": [[{ "node": "Function - Preparar Link Drive", "type": "main", "index": 0 }]] },
    "Function - Preparar Link Drive": { "main": [[{ "node": "Preparar Datos Solicitudes", "type": "main", "index": 0 }]] },
    "Preparar Datos Solicitudes": { "main": [[{ "node": "DB-Registro", "type": "main", "index": 0 }]] },
    "Preparar Datos Log": { "main": [[{ "node": "DB-Log", "type": "main", "index": 0 }]] },
    "DB-Registro": { "main": [[{ "node": "Sincronizar - Preservar Datos", "type": "main", "index": 0 }]] },
    "DB-Log": { "main": [[{ "node": "Sincronizar - Preservar Datos", "type": "main", "index": 0 }]] },
    "Email-Confirmaci√≥n": { "main": [[{ "node": "Sincronizar - Preservar Datos", "type": "main", "index": 0 }]] },
    "HTTP-Notificar HU-005": { "main": [[{ "node": "Function - Log Error PDF", "type": "main", "index": 0 }]] },
    "Function - Log Error PDF": {
      "main": [
        [
          { "node": "DB-Log", "type": "main", "index": 0 },
          { "node": "Function - Error PDF Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Function - Log Error Validaci√≥n": {
      "main": [
        [
          { "node": "DB-Log", "type": "main", "index": 0 },
          { "node": "Function-Error Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Sincronizar - Preservar Datos": { "main": [[{ "node": "Function-Success Response", "type": "main", "index": 0 }]] },

    "Webhook-HU004": { "main": [[{ "node": "Function-ValidarEntrada", "type": "main", "index": 0 }]] },
    "Function-ValidarEntrada": { "main": [[{ "node": "IF-DatosValidos", "type": "main", "index": 0 }]] },
    "IF-DatosValidos": {
      "main": [
        [{ "node": "Function-PrepararDatos", "type": "main", "index": 0 }],
        [{ "node": "Respond-Error-Validacion", "type": "main", "index": 0 }]
      ]
    },
    "Function-PrepararDatos": { "main": [[{ "node": "Function-RedactarEmail", "type": "main", "index": 0 }]] },
    "Function-RedactarEmail": { "main": [[{ "node": "Email-Correccion", "type": "main", "index": 0 }]] },
    "Email-Correccion": {
      "main": [
        [{ "node": "Respond-Success", "type": "main", "index": 0 }],
        [{ "node": "Function-LogErrorSMTP", "type": "main", "index": 0 }]
      ]
    },
    "Function-LogErrorSMTP": { "main": [[{ "node": "Respond-Error-SMTP", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" },
  "staticData": null,
  "tags": [
    { "name": "HU-001" },
    { "name": "HU-005" }
  ],
  "active": false,
  "versionId": "convalidaciones-hu001-hu005-v1"
}
